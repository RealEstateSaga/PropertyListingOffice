import{V as o,m as i,n as l}from"./index-BM-DvTdL.js";import{C as r}from"./CopyText-9n7KkK8B.js";const n=o.extend({name:"UserProfile",components:{CopyText:r},data(){return{form:{},data:{},isTotpVisible:!1,totpQR:null,totpSecret:null,totpCode:"",showDisableTOTP:!1,disableTOTPPassword:"",twofaEnabled:!1}},methods:{onSubmit(){const a={name:this.form.name,email:this.form.email};if(this.data.passwordLogin&&this.form.password){if(this.form.password!==this.form.password2){this.$utils.toast(this.$t("users.passwordMismatch"),"is-danger");return}a.password=this.form.password,a.password2=this.form.password2}this.$api.updateUserProfile(a).then(()=>{this.form.password="",this.form.password2="",this.$utils.toast(this.$t("globals.messages.updated",{name:this.data.username}))})},onToggleEnableTotp(){this.$api.getTOTPQR(this.data.id).then(a=>{this.totpQR=a.qr,this.totpSecret=a.secret,this.isTotpVisible=!0,this.$nextTick(()=>{this.$refs.totpCodeInput&&this.$refs.totpCodeInput.focus()})}).catch(()=>{this.$utils.toast(this.$t("globals.messages.errorFetching"),"is-danger")})},onCancelTOTPSetup(){this.isTotpVisible=!1,this.totpQR=null,this.totpSecret=null,this.totpCode="",this.twofaEnabled=this.data.twofaType==="totp",this.showDisableTOTP=!1,this.disableTOTPPassword=""},confirmTOTP(){if(!this.totpCode||this.totpCode.length!==6){this.$utils.toast(this.$t("globals.messages.invalidValue"),"is-danger");return}const a=new FormData;a.append("secret",this.totpSecret),a.append("code",this.totpCode),this.$api.enableTOTP(this.data.id,a).then(()=>{this.$utils.toast(this.$t("users.twoFAEnabled")),this.onCancelTOTPSetup(),this.$api.getUserProfile().then(t=>{this.data={...t},this.twofaEnabled=t.twofaType==="totp"})}).catch(()=>{this.$utils.toast(this.$t("globals.messages.invalidValue"),"is-danger")})},toggleDisableTOTP(){this.showDisableTOTP=!0,this.$nextTick(()=>{this.$refs.disablePasswordInput&&this.$refs.disablePasswordInput.focus()})},cancelDisableTOTP(){this.showDisableTOTP=!1,this.disableTOTPPassword=""},confirmDisableTOTP(){if(!this.disableTOTPPassword){this.$utils.toast(this.$t("globals.messages.invalidFields"),"is-danger");return}const a=new FormData;a.append("password",this.disableTOTPPassword),this.$api.disableTOTP(this.data.id,a).then(()=>{this.$utils.toast(this.$t("globals.messages.done")),this.showDisableTOTP=!1,this.disableTOTPPassword="",this.$api.getUserProfile().then(t=>{this.data={...t},this.twofaEnabled=t.twofaType==="totp"})}).catch(()=>{this.$utils.toast(this.$t("users.invalidPassword"),"is-danger")})}},mounted(){this.$api.getUserProfile().then(a=>{this.data={...a},this.form={name:a.name,email:a.email},this.twofaEnabled=a.twofaType==="totp"})},computed:{...i(["loading"])}});var d=function(){var t=this,s=t._self._c;return t._self._setupProxy,s("section",{staticClass:"user-profile section-mini"},[t.loading.users?s("b-loading",{attrs:{active:t.loading.users,"is-full-page":!1}}):t._e(),s("h1",{staticClass:"title"},[t._v(" @"+t._s(t.data.username)+" ")]),t.data.userRole?s("b-tag",[t._v(t._s(t.data.userRole.name))]):t._e(),s("br"),s("br"),s("br"),s("form",{on:{submit:function(e){return e.preventDefault(),t.onSubmit.apply(null,arguments)}}},[t.data.type!=="api"?s("b-field",{attrs:{label:t.$t("subscribers.email"),"label-position":"on-border"}},[s("b-input",{attrs:{maxlength:200,name:"email",placeholder:t.$t("subscribers.email"),disabled:!t.data.passwordLogin,required:"",autofocus:""},model:{value:t.form.email,callback:function(e){t.$set(t.form,"email",e)},expression:"form.email"}})],1):t._e(),s("b-field",{attrs:{label:t.$t("globals.fields.name"),"label-position":"on-border"}},[s("b-input",{attrs:{maxlength:200,name:"name",placeholder:t.$t("globals.fields.name")},model:{value:t.form.name,callback:function(e){t.$set(t.form,"name",e)},expression:"form.name"}})],1),t.data.passwordLogin?s("div",{staticClass:"columns"},[s("div",{staticClass:"column is-6"},[s("b-field",{attrs:{label:t.$t("users.password"),"label-position":"on-border"}},[s("b-input",{attrs:{minlength:"8",maxlength:200,type:"password",name:"password",placeholder:t.$t("users.password")},model:{value:t.form.password,callback:function(e){t.$set(t.form,"password",e)},expression:"form.password"}})],1)],1),s("div",{staticClass:"column is-6"},[s("b-field",{attrs:{label:t.$t("users.passwordRepeat"),"label-position":"on-border"}},[s("b-input",{attrs:{minlength:"8",maxlength:200,type:"password",name:"password2"},model:{value:t.form.password2,callback:function(e){t.$set(t.form,"password2",e)},expression:"form.password2"}})],1)],1)]):t._e(),s("b-field",{attrs:{expanded:""}},[s("b-button",{attrs:{type:"is-primary","icon-left":"content-save-outline","native-type":"submit","data-cy":"btn-save"}},[t._v(" "+t._s(t.$t("globals.buttons.save"))+" ")])],1)],1),s("br"),s("br"),this.data.passwordLogin?s("section",{staticClass:"twofa-section"},[t.data.twofaType==="none"?s("div",{staticClass:"box"},[s("div",{staticClass:"columns is-vcentered mb-4"},[s("div",{staticClass:"column"},[s("h3",{staticClass:"title is-size-5 mb-0"},[t._v(t._s(t.$t("users.twoFA")))])]),s("div",{staticClass:"column is-narrow"},[t.isTotpVisible?t._e():s("b-switch",{on:{input:t.onToggleEnableTotp},model:{value:t.twofaEnabled,callback:function(e){t.twofaEnabled=e},expression:"twofaEnabled"}})],1)]),s("p",[t._v(t._s(t.$t("users.twoFANotEnabled")))]),s("br"),t.isTotpVisible?s("div",{staticClass:"totp-setup"},[t.totpQR?s("div",{staticClass:"qr-section"},[s("p",{staticClass:"has-text-grey"},[t._v(t._s(t.$t("users.totpScanQR")))]),s("br"),s("img",{attrs:{src:"data:image/png;base64,"+t.totpQR,alt:"QR Code"}}),s("br"),s("br"),s("p",[s("strong",[t._v(t._s(t.$t("users.totpSecret")))]),s("br"),s("code",[s("copy-text",{attrs:{text:`${t.totpSecret}`}})],1)]),s("br"),s("br"),s("form",{on:{submit:function(e){return e.preventDefault(),t.confirmTOTP.apply(null,arguments)}}},[s("b-field",{attrs:{label:t.$t("users.totpCode"),"label-position":"on-border"}},[s("b-input",{ref:"totpCodeInput",attrs:{maxlength:"6",pattern:"[0-9]{6}",placeholder:"000000",required:""},model:{value:t.totpCode,callback:function(e){t.totpCode=e},expression:"totpCode"}})],1),s("div",{staticClass:"buttons"},[s("b-button",{attrs:{type:"is-primary","native-type":"submit"}},[t._v(" "+t._s(t.$t("globals.buttons.enable"))+" ")]),s("b-button",{attrs:{type:"button"},on:{click:t.onCancelTOTPSetup}},[t._v(" "+t._s(t.$t("globals.buttons.cancel"))+" ")])],1)],1)]):t._e()]):t._e()]):t._e(),t.data.twofaType==="totp"?s("div",{staticClass:"box"},[s("div",{staticClass:"columns is-vcentered"},[s("div",{staticClass:"column"},[s("h3",{staticClass:"title is-size-5"},[s("b-icon",{attrs:{icon:"check-circle-outline",type:"is-success"}}),t._v(" "+t._s(t.$t("users.twoFAEnabled"))+" ")],1)]),s("div",{staticClass:"column is-narrow"},[t.showDisableTOTP?t._e():s("b-switch",{on:{input:t.toggleDisableTOTP},model:{value:t.twofaEnabled,callback:function(e){t.twofaEnabled=e},expression:"twofaEnabled"}})],1)]),s("p",[t._v(t._s(t.$t("users.twoFAEnabledDesc",{type:t.data.twofaType.toUpperCase()})))]),t.showDisableTOTP?s("form",{staticClass:"disable-totp mt-5",on:{submit:function(e){return e.preventDefault(),t.confirmDisableTOTP.apply(null,arguments)}}},[s("b-field",{attrs:{label:t.$t("users.password"),"label-position":"on-border"}},[s("b-input",{ref:"disablePasswordInput",attrs:{type:"password",minlength:"8",required:""},model:{value:t.disableTOTPPassword,callback:function(e){t.disableTOTPPassword=e},expression:"disableTOTPPassword"}})],1),s("div",{staticClass:"buttons"},[s("b-button",{attrs:{type:"is-danger","native-type":"submit"}},[t._v(" "+t._s(t.$t("globals.buttons.disable"))+" ")]),s("b-button",{attrs:{type:"button"},on:{click:t.onCancelTOTPSetup}},[t._v(" "+t._s(t.$t("globals.buttons.cancel"))+" ")])],1)],1):t._e()]):t._e()]):t._e()],1)},p=[],b=l(n,d,p);const m=b.exports;export{m as default};
